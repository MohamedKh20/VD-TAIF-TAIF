<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📋 الكشفيات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f8f9fa; margin:0; padding:0; }
    .container { max-width:800px; margin:auto; padding:30px 20px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:10px; margin-top:40px; }
    h2 { text-align:center; margin-bottom:20px; color:#007bff; }
    .btn-back { display:block; margin:0 auto 20px; padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
    label { display:block; margin:15px 0 5px; font-weight:bold; }
    input[type="text"], input[type="file"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    iframe { width:100%; height:300px; border-radius:8px; margin-top:10px; border:0; }
    .image-gallery img { width:100%; height:300px; border-radius:8px; margin:10px 0; object-fit:cover; display:block; }
    .image-gallery a { text-decoration:none; }
    button.submit-btn { margin-top:30px; padding:12px; background:#007bff; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; width:100%; }
    button.submit-btn:hover { background:#0056b3; }
    #responseMsg { margin-top:20px; text-align:center; font-weight:bold; color:#28a745; }
    #notFoundMsg { margin-top:10px; text-align:center; color:red; font-weight:bold; }
    .err { color:#d00; font-size:13px; margin:-6px 0 10px; }
  </style>
</head>
<body>
<div class="container">
  <h2>📋 الكشفيات</h2>
  <button class="btn-back" onclick="window.location.href='user-dashboard.html'">🔙 العودة للرئيسية</button>

  <label>رقم الإشعار</label>
<input type="text" id="noticeInput" placeholder="أدخل رقم الإشعار">
<button class="submit-btn" onclick="loadData()">🔍 بحث</button>
<div id="notFoundMsg"></div>
  <label>📍 الموقع الجغرافي</label>
  <iframe id="mapFrame" src="" allowfullscreen></iframe>

  <label>📷 الصور المحفوظة</label>
  <div id="oldImages" class="image-gallery">
    <img src="https://via.placeholder.com/800x300?text=🚫+لا+توجد+صور" alt="">
  </div>

  <label>📷 تصوير الكشفيه الجديدة</label>
  <input type="file" accept="image/*" capture="environment" id="newImage">
  <button class="submit-btn" onclick="submitKashf()">إرسال</button>
  <div id="responseMsg"></div>
  <p>تم التنفيذ بواسطة م/محمد خالد جميع الحقوق محفوظة</p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoVAUYKSSyYcEOZu0yJXcBFPJHot1w0z3Er3fuPqDUyIghSPLJcHRFxofWqy8uxnnHvA/exec";

/* ===================== أدوات مساعدة للصور ===================== */
// استخراج fileId من روابط Google Drive (سواء /file/d/ID/... أو ?id=ID)
function extractDriveId(url) {
  try {
    const u = new URL(url);
    if (!u.hostname.includes('drive.google')) return null;
    const m = u.pathname.match(/\/file\/d\/([^/]+)/);
    if (m && m[1]) return m[1];
    const id = u.searchParams.get('id');
    if (id) return id;
  } catch (e) {}
  return null;
}

// تحويل أي قيمة لصيغة صالحة للعرض داخل <img>
function normalizeImageSrc(raw) {
  if (!raw) return '';

  // Base64 خام
  const isBase64 = /^[A-Za-z0-9+/=\s]+$/.test(raw) && raw.length > 100 && !raw.startsWith('http');
  if (isBase64) return `data:image/jpeg;base64,${raw.trim()}`;

  // data: image جاهز
  if (raw.startsWith('data:image')) return raw;

  // غير روابط Drive → نرجعها كما هي
  const id = extractDriveId(raw);
  if (!id) return raw;

  // أول محاولة: lh3 (سريع ومستقر للصور)
  return `https://lh3.googleusercontent.com/d/${id}=w1600`;
}

// يبني <img> مع فواصل سقوط تلقائية لمصادر بديلة من Google Drive
function imgTag(originalSrc) {
  const id = extractDriveId(originalSrc);
  const originalEsc = (originalSrc || '').replace(/"/g, '&quot;');

  if (!id) {
    // مش Google Drive → استخدم normalize فقط
    const src1 = normalizeImageSrc(originalSrc);
    return `
      <a href="${originalEsc}" target="_blank" rel="noopener">
        <img src="${src1}" alt="image" loading="lazy" referrerpolicy="no-referrer"
             onerror="this.insertAdjacentHTML('afterend',
               '<div class=&quot;err&quot;><b>تعذر عرض الصورة</b> — راجع الصلاحيات أو الرابط.</div>'); this.remove();">
      </a>`;
  }

  // مرشّحات بديلة بالترتيب
  const candidates = [
    `https://lh3.googleusercontent.com/d/${id}=w1600`,
    `https://drive.usercontent.google.com/download?id=${id}&export=view`,
    `https://drive.google.com/thumbnail?id=${id}&sz=w1600`
  ];

  // نولّد img يبدأ بأول مصدر، ولو فشل ينتقل للي بعده
  return `
    <a href="${originalEsc}" target="_blank" rel="noopener">
      <img src="${candidates[0]}" alt="image" loading="lazy"
           referrerpolicy="no-referrer" crossorigin="anonymous"
           data-fallback="${candidates.slice(1).join('|')}"
           onerror="
             const rest = (this.dataset.fallback || '').split('|').filter(Boolean);
             if (rest.length) { this.src = rest.shift(); this.dataset.fallback = rest.join('|'); }
             else { this.insertAdjacentHTML('afterend',
               '<div class=&quot;err&quot;><b>تعذر عرض الصورة</b> — راجع صلاحيات المشاركة أو نوع الملف.</div>'); this.remove(); }
           ">
    </a>`;
}

/* ===================== تحميل البيانات ===================== */
async function loadData() {
  const noticeNumber = document.getElementById("noticeInput").value.trim();
  const notFoundMsg = document.getElementById("notFoundMsg");
  const mapFrame = document.getElementById("mapFrame");
  const oldImages = document.getElementById("oldImages");

  // لو الحقل فاضي → نظف الصفحة
  if (!noticeNumber) {
    notFoundMsg.innerText = "";
    mapFrame.src = "";
    oldImages.innerHTML = `<p style="text-align:center; color:#888;">📷 لا توجد صور</p><p style="text-align:center; color:#888;">📍 لا يوجد موقع</p>`;
    return;
  }

  try {
    const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(noticeNumber)}&t=${Date.now()}`);
    const data = await response.json();

    if (data.status === "not_found") {
      notFoundMsg.innerText = "⚠️ رقم الإشعار غير موجود.";
      mapFrame.src = "";
      oldImages.innerHTML = `<p style="text-align:center; color:#888;">📷 لا توجد صور</p><p style="text-align:center; color:#888;">📍 لا يوجد موقع</p>`;
      return;
    }

    notFoundMsg.innerText = "";

    let html = "";

    // الموقع الجغرافي
    if (data.lat && data.lon && data.lat !== "0" && data.lon !== "0") {
      mapFrame.src = `https://www.google.com/maps?q=${data.lat},${data.lon}&output=embed`;
    } else {
      mapFrame.src = "";
      html += `<p style="text-align:center; color:#888;">📍 لا يوجد موقع</p>`;
    }

    // الصور
    const old = Array.isArray(data.imagesOld) ? data.imagesOld : [];
    const neu = Array.isArray(data.imagesNew) ? data.imagesNew : [];

    if (old.length > 0) {
      html += `<h4>📂 صور قديمة</h4>` + old.slice(0, 3).map(imgTag).join("");
    }
    if (neu.length > 0) {
      html += `<h4>📸 صور جديدة</h4>` + neu.slice(0, 3).map(imgTag).join("");
    }
    if (old.length === 0 && neu.length === 0) {
      html += `<p style="text-align:center; color:#888;">📷 لا توجد صور</p>`;
    }

    oldImages.innerHTML = html;

  } catch (error) {
    console.error("خطأ أثناء جلب البيانات:", error);
    notFoundMsg.innerText = "⚠️ حدث خطأ أثناء الاتصال بالخادم.";
    mapFrame.src = "";
    oldImages.innerHTML = `<p style="text-align:center; color:#888;">📷 لا توجد صور</p><p style="text-align:center; color:#888;">📍 لا يوجد موقع</p>`;
  }
}
/* ===================== رفع صورة جديدة ===================== */
async function submitKashf() {
  const file = document.getElementById("newImage").files[0];
  const noticeNumber = document.getElementById("noticeInput").value.trim();
  const responseMsg = document.getElementById("responseMsg");
  const oldImages = document.getElementById("oldImages");
  const mapFrame = document.getElementById("mapFrame");

  if (!file || !noticeNumber) {
    responseMsg.innerText = "يرجى إدخال رقم الإشعار وتصوير الصورة.";
    return;
  }

  const reader = new FileReader();
  reader.onloadend = async function() {
    try {
      const base64 = reader.result.split(",")[1];
      const formData = new FormData();
      formData.append("image", base64);
      formData.append("notifyId", noticeNumber);

      await fetch(SCRIPT_URL, { method: "POST", body: formData });

      responseMsg.innerHTML = `✅ تم الإرسال بنجاح`;

      setTimeout(() => {
  document.getElementById("noticeInput").value = "";
  document.getElementById("newImage").value = "";
  document.getElementById("oldImages").innerHTML = `<img src="https://via.placeholder.com/800x300?text=🚫+لا+توجد+صور" alt="">`;
  document.getElementById("mapFrame").src = "";
  document.getElementById("notFoundMsg").innerText = "";
  document.getElementById("responseMsg").innerText = "";
}, 1000);

    } catch (err) {
      responseMsg.innerText = "⚠️ حدث خطأ أثناء رفع الصورة.";
      console.error("خطأ رفع الصورة:", err);
    }
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
