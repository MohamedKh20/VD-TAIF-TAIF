<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Ø§Ù„ÙƒØ´ÙÙŠØ§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f8f9fa; margin:0; padding:0; }
    .container { max-width:800px; margin:auto; padding:30px 20px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:10px; margin-top:40px; }
    h2 { text-align:center; margin-bottom:20px; color:#007bff; }
    .btn-back { display:block; margin:0 auto 20px; padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
    label { display:block; margin:15px 0 5px; font-weight:bold; }
    input[type="text"], input[type="file"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    iframe { width:100%; height:300px; border-radius:8px; margin-top:10px; border:0; }
    .image-gallery img { width:100%; height:300px; border-radius:8px; margin:10px 0; object-fit:cover; display:block; }
    .image-gallery a { text-decoration:none; }
    button.submit-btn { margin-top:30px; padding:12px; background:#007bff; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; width:100%; }
    button.submit-btn:hover { background:#0056b3; }
    #responseMsg { margin-top:20px; text-align:center; font-weight:bold; color:#28a745; }
    #notFoundMsg { margin-top:10px; text-align:center; color:red; font-weight:bold; }
    .err { color:#d00; font-size:13px; margin:-6px 0 10px; }
  </style>
</head>
<body>
<div class="container">
  <h2>ğŸ“‹ Ø§Ù„ÙƒØ´ÙÙŠØ§Øª</h2>
  <button class="btn-back" onclick="window.location.href='user-dashboard.html'">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

  <label>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
<input type="text" id="noticeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
<button class="submit-btn" onclick="loadData()">ğŸ” Ø¨Ø­Ø«</button>
<div id="notFoundMsg"></div>
  <label>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</label>
  <iframe id="mapFrame" src="" allowfullscreen></iframe>

  <label>ğŸ“· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
  <div id="oldImages" class="image-gallery">
    <img src="https://via.placeholder.com/800x300?text=ğŸš«+Ù„Ø§+ØªÙˆØ¬Ø¯+ØµÙˆØ±" alt="">
  </div>

  <label>ğŸ“· ØªØµÙˆÙŠØ± Ø§Ù„ÙƒØ´ÙÙŠÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
  <input type="file" accept="image/*" capture="environment" id="newImage">
  <button class="submit-btn" onclick="submitKashf()">Ø¥Ø±Ø³Ø§Ù„</button>
  <div id="responseMsg"></div>
  <p>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© Ù…/Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoVAUYKSSyYcEOZu0yJXcBFPJHot1w0z3Er3fuPqDUyIghSPLJcHRFxofWqy8uxnnHvA/exec";

/* ===================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØµÙˆØ± ===================== */
// Ø§Ø³ØªØ®Ø±Ø§Ø¬ fileId Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Google Drive (Ø³ÙˆØ§Ø¡ /file/d/ID/... Ø£Ùˆ ?id=ID)
function extractDriveId(url) {
  try {
    const u = new URL(url);
    if (!u.hostname.includes('drive.google')) return null;
    const m = u.pathname.match(/\/file\/d\/([^/]+)/);
    if (m && m[1]) return m[1];
    const id = u.searchParams.get('id');
    if (id) return id;
  } catch (e) {}
  return null;
}

// ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØµÙŠØºØ© ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ <img>
function normalizeImageSrc(raw) {
  if (!raw) return '';

  // Base64 Ø®Ø§Ù…
  const isBase64 = /^[A-Za-z0-9+/=\s]+$/.test(raw) && raw.length > 100 && !raw.startsWith('http');
  if (isBase64) return `data:image/jpeg;base64,${raw.trim()}`;

  // data: image Ø¬Ø§Ù‡Ø²
  if (raw.startsWith('data:image')) return raw;

  // ØºÙŠØ± Ø±ÙˆØ§Ø¨Ø· Drive â†’ Ù†Ø±Ø¬Ø¹Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
  const id = extractDriveId(raw);
  if (!id) return raw;

  // Ø£ÙˆÙ„ Ù…Ø­Ø§ÙˆÙ„Ø©: lh3 (Ø³Ø±ÙŠØ¹ ÙˆÙ…Ø³ØªÙ‚Ø± Ù„Ù„ØµÙˆØ±)
  return `https://lh3.googleusercontent.com/d/${id}=w1600`;
}

// ÙŠØ¨Ù†ÙŠ <img> Ù…Ø¹ ÙÙˆØ§ØµÙ„ Ø³Ù‚ÙˆØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù…ØµØ§Ø¯Ø± Ø¨Ø¯ÙŠÙ„Ø© Ù…Ù† Google Drive
function imgTag(originalSrc) {
  const id = extractDriveId(originalSrc);
  const originalEsc = (originalSrc || '').replace(/"/g, '&quot;');

  if (!id) {
    // Ù…Ø´ Google Drive â†’ Ø§Ø³ØªØ®Ø¯Ù… normalize ÙÙ‚Ø·
    const src1 = normalizeImageSrc(originalSrc);
    return `
      <a href="${originalEsc}" target="_blank" rel="noopener">
        <img src="${src1}" alt="image" loading="lazy" referrerpolicy="no-referrer"
             onerror="this.insertAdjacentHTML('afterend',
               '<div class=&quot;err&quot;><b>ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</b> â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø·.</div>'); this.remove();">
      </a>`;
  }

  // Ù…Ø±Ø´Ù‘Ø­Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
  const candidates = [
    `https://lh3.googleusercontent.com/d/${id}=w1600`,
    `https://drive.usercontent.google.com/download?id=${id}&export=view`,
    `https://drive.google.com/thumbnail?id=${id}&sz=w1600`
  ];

  // Ù†ÙˆÙ„Ù‘Ø¯ img ÙŠØ¨Ø¯Ø£ Ø¨Ø£ÙˆÙ„ Ù…ØµØ¯Ø±ØŒ ÙˆÙ„Ùˆ ÙØ´Ù„ ÙŠÙ†ØªÙ‚Ù„ Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡
  return `
    <a href="${originalEsc}" target="_blank" rel="noopener">
      <img src="${candidates[0]}" alt="image" loading="lazy"
           referrerpolicy="no-referrer" crossorigin="anonymous"
           data-fallback="${candidates.slice(1).join('|')}"
           onerror="
             const rest = (this.dataset.fallback || '').split('|').filter(Boolean);
             if (rest.length) { this.src = rest.shift(); this.dataset.fallback = rest.join('|'); }
             else { this.insertAdjacentHTML('afterend',
               '<div class=&quot;err&quot;><b>ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</b> â€” Ø±Ø§Ø¬Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù.</div>'); this.remove(); }
           ">
    </a>`;
}

/* ===================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===================== */
async function loadData() {
  const noticeNumber = document.getElementById("noticeInput").value.trim();
  const notFoundMsg = document.getElementById("notFoundMsg");
  const mapFrame = document.getElementById("mapFrame");
  const oldImages = document.getElementById("oldImages");

  // Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø¶ÙŠ â†’ Ù†Ø¸Ù Ø§Ù„ØµÙØ­Ø©
  if (!noticeNumber) {
    notFoundMsg.innerText = "";
    mapFrame.src = "";
    oldImages.innerHTML = `<p style="text-align:center; color:#888;">ğŸ“· Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p><p style="text-align:center; color:#888;">ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹</p>`;
    return;
  }

  try {
    const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(noticeNumber)}&t=${Date.now()}`);
    const data = await response.json();

    if (data.status === "not_found") {
      notFoundMsg.innerText = "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
      mapFrame.src = "";
      oldImages.innerHTML = `<p style="text-align:center; color:#888;">ğŸ“· Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p><p style="text-align:center; color:#888;">ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹</p>`;
      return;
    }

    notFoundMsg.innerText = "";

    let html = "";

    // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
    if (data.lat && data.lon && data.lat !== "0" && data.lon !== "0") {
      mapFrame.src = `https://www.google.com/maps?q=${data.lat},${data.lon}&output=embed`;
    } else {
      mapFrame.src = "";
      html += `<p style="text-align:center; color:#888;">ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹</p>`;
    }

    // Ø§Ù„ØµÙˆØ±
    const old = Array.isArray(data.imagesOld) ? data.imagesOld : [];
    const neu = Array.isArray(data.imagesNew) ? data.imagesNew : [];

    if (old.length > 0) {
      html += `<h4>ğŸ“‚ ØµÙˆØ± Ù‚Ø¯ÙŠÙ…Ø©</h4>` + old.slice(0, 3).map(imgTag).join("");
    }
    if (neu.length > 0) {
      html += `<h4>ğŸ“¸ ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h4>` + neu.slice(0, 3).map(imgTag).join("");
    }
    if (old.length === 0 && neu.length === 0) {
      html += `<p style="text-align:center; color:#888;">ğŸ“· Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p>`;
    }

    oldImages.innerHTML = html;

  } catch (error) {
    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    notFoundMsg.innerText = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
    mapFrame.src = "";
    oldImages.innerHTML = `<p style="text-align:center; color:#888;">ğŸ“· Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p><p style="text-align:center; color:#888;">ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹</p>`;
  }
}
/* ===================== Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ===================== */
async function submitKashf() {
  const file = document.getElementById("newImage").files[0];
  const noticeNumber = document.getElementById("noticeInput").value.trim();
  const responseMsg = document.getElementById("responseMsg");
  const oldImages = document.getElementById("oldImages");
  const mapFrame = document.getElementById("mapFrame");

  if (!file || !noticeNumber) {
    responseMsg.innerText = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØªØµÙˆÙŠØ± Ø§Ù„ØµÙˆØ±Ø©.";
    return;
  }

  const reader = new FileReader();
  reader.onloadend = async function() {
    try {
      const base64 = reader.result.split(",")[1];
      const formData = new FormData();
      formData.append("image", base64);
      formData.append("notifyId", noticeNumber);

      await fetch(SCRIPT_URL, { method: "POST", body: formData });

      responseMsg.innerHTML = `âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­`;

      setTimeout(() => {
  document.getElementById("noticeInput").value = "";
  document.getElementById("newImage").value = "";
  document.getElementById("oldImages").innerHTML = `<img src="https://via.placeholder.com/800x300?text=ğŸš«+Ù„Ø§+ØªÙˆØ¬Ø¯+ØµÙˆØ±" alt="">`;
  document.getElementById("mapFrame").src = "";
  document.getElementById("notFoundMsg").innerText = "";
  document.getElementById("responseMsg").innerText = "";
}, 1000);

    } catch (err) {
      responseMsg.innerText = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.";
      console.error("Ø®Ø·Ø£ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", err);
    }
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
